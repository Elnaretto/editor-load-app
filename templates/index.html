<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>–ù–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
</head>
<body class="container py-4">

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="mb-4 d-flex gap-2">
        <a href="{{ url_for('index') }}" class="btn btn-outline-primary">üè† –ì–ª–∞–≤–Ω–∞—è</a>
        <a href="{{ url_for('visualization') }}" class="btn btn-outline-success">üìä –ü–æ —à–µ—Ñ—É</a>
        <a href="{{ url_for('visualization_timeline') }}" class="btn btn-outline-info">üìà –î–∏–Ω–∞–º–∏–∫–∞</a>
    </div>

    <h1>–î–æ–±–∞–≤–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞</h1>

    <button onclick="window.location.href='{{ url_for('visualization') }}'" class="btn btn-secondary mb-3">–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</button>

    <form id="load-form" method="POST" action="{{ url_for('submit_loads') }}">
        <label for="chief">–í—ã–±–µ—Ä–∏—Ç–µ —à–µ—Ñ–∞:</label>
        <select id="chief" name="chief" required onchange="updateEditors()" class="form-select w-auto">
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
            {% for chief in chiefs %}
                <option value="{{ chief.id }}">{{ chief.name }}</option>
            {% endfor %}
        </select>

        <br><br>

        <label for="editor">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞:</label>
        <select id="editor" name="editor" required class="form-select w-auto" onchange="loadEditorLoads()">
            <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —à–µ—Ñ–∞ --</option>
        </select>

        <br><br>

        <label for="date">–î–∞—Ç–∞:</label>
        <input type="date" id="date" name="date" value="{{ today }}" required class="form-control w-auto" onchange="loadEditorLoads()">

        <br><br>

        <h3>–í–≤–µ–¥–∏—Ç–µ —á–∞—Å—ã –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º</h3>
        <div class="mb-3 border p-3 rounded">
            {% for project in projects %}
                <div class="mb-2 d-flex align-items-center gap-2" data-project-id="{{ project.id }}">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background-color:
                        {% if project.priority == 'team-high' %}#ffcc00
                        {% elif project.priority == 'all-high' %}#ff0000
                        {% elif project.priority == 'above-average' %}#ff0000
                        {% elif project.priority == 'medium' %}#007bff
                        {% elif project.priority == 'low' %}#007bff
                        {% else %}#cccccc{% endif %};
                    " title="–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {{ project.priority }}"></div>
                    <label for="hours_{{ project.id }}" class="flex-grow-1 mb-0">{{ project.name }}</label>
                    <input type="number" step="0.1" name="hours_{{ project.id }}" id="hours_{{ project.id }}" value="0" class="form-control w-auto" style="max-width: 80px;" placeholder="¬± —á–∞—Å—ã">
                    <span id="display_hours_{{ project.id }}" class="ms-2">0</span>
                    <select name="priority_{{ project.id }}" class="form-select form-select-sm w-auto ms-2" style="min-width: 180px;">
                        <option value="team-high" {% if project.priority == 'team-high' %}selected{% endif %}>‚ö†Ô∏è –í—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –∫–æ–º–∞–Ω–¥—ã</option>
                        <option value="all-high" {% if project.priority == 'all-high' %}selected{% endif %}>‚ùó‚ùó‚ùó –í—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –≤—Å–µ—Ö</option>
                        <option value="above-average" {% if project.priority == 'above-average' %}selected{% endif %}>‚ùó –í—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                        <option value="medium" {% if project.priority == 'medium' %}selected{% endif %}>üîµ‚ùó –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                        <option value="low" {% if project.priority == 'low' %}selected{% endif %}>üîµ‚ùì –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                    </select>
                </div>
            {% endfor %}
        </div>

        <button type="button" id="submit-loads-btn" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>

    <button type="button" id="clear-hours-btn" class="btn btn-warning mb-3">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —á–∞—Å—ã –Ω–∞–≥—Ä—É–∑–∫–∏</button>

    <hr>

    <h5>–í—ã–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ Excel</h5>
    <form method="GET" action="{{ url_for('export_excel') }}" class="mb-4">
        <label for="startDate">–°:</label>
        <input type="date" id="startDate" name="start_date" required>
        <label for="endDate">–ü–æ:</label>
        <input type="date" id="endDate" name="end_date" required>
        <button type="submit" class="btn btn-primary ms-2">–í—ã–≥—Ä—É–∑–∏—Ç—å Excel</button>
    </form>

    <h5>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h5>
    <div style="max-width: 300px;">
        <input type="text" id="project-name-input" class="form-control mb-2" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞" />
        <select id="priority-select" class="form-select mb-2">
            <option value="team-high">‚ö†Ô∏è –í—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –∫–æ–º–∞–Ω–¥—ã</option>
            <option value="all-high">‚ùó‚ùó‚ùó –í—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –≤—Å–µ—Ö</option>
            <option value="above-average">‚ùó –í—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
            <option value="medium" selected>üîµ‚ùó –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
            <option value="low">üîµ‚ùì –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
        </select>
        <button id="save-project-btn" type="button" class="btn btn-primary mb-4">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
        <div id="project-status-msg" class="text-success" style="display:none;"></div>
    </div>

    <button id="delete-loads-btn" type="button" class="btn btn-danger mb-3">–£–¥–∞–ª–∏—Ç—å —á–∞—Å—ã –Ω–∞–≥—Ä—É–∑–∫–∏</button>

<script>
const editorsByChief = {
    {% for chief in chiefs %}
    "{{ chief.id }}": [
        {% for editor in chief.editors %}
        {"id": "{{ editor.id }}", "login": "{{ editor.login }}"},
        {% endfor %}
    ],
    {% endfor %}
};

function updateEditors() {
    const chiefSelect = document.getElementById('chief');
    const editorSelect = document.getElementById('editor');
    const selectedChief = chiefSelect.value;

    editorSelect.innerHTML = '';

    if (!selectedChief || !editorsByChief[selectedChief]) {
        editorSelect.innerHTML = '<option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —à–µ—Ñ–∞ --</option>';
        clearLoadForm();
        return;
    }

    const editors = editorsByChief[selectedChief];
    editorSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ --</option>';

    editors.forEach(editor => {
        const option = document.createElement('option');
        option.value = editor.id;
        option.textContent = editor.login;
        editorSelect.appendChild(option);
    });

    clearLoadForm();
}

function clearLoadForm() {
    document.querySelectorAll('[data-project-id]').forEach(div => {
        const projectId = div.getAttribute('data-project-id');
        const hoursInput = document.getElementById(`hours_${projectId}`);
        const prioritySelect = div.querySelector(`select[name="priority_${projectId}"]`);
        const displaySpan = document.getElementById(`display_hours_${projectId}`);

        if (hoursInput) hoursInput.value = '0';
        if (prioritySelect) prioritySelect.value = 'medium';
        if (displaySpan) displaySpan.textContent = '0';
    });
}

async function loadEditorLoads() {
    const editorId = document.getElementById('editor').value;
    const date = document.getElementById('date').value;

    if (!editorId || !date) {
        clearLoadForm();
        return;
    }

    try {
        const response = await fetch(`/get_loads?editor_id=${editorId}&date=${date}`);
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        const data = await response.json();

        clearLoadForm();

        data.loads.forEach(load => {
            const hoursInput = document.getElementById(`hours_${load.project_id}`);
            const prioritySelect = document.querySelector(`select[name="priority_${load.project_id}"]`);
            const displaySpan = document.getElementById(`display_hours_${load.project_id}`);

            if (hoursInput) hoursInput.value = load.hours;
            if (prioritySelect) prioritySelect.value = load.priority;
            if (displaySpan) displaySpan.textContent = parseFloat(load.hours).toFixed(2);
        });
    } catch (e) {
        console.error(e);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞');
    }
}

document.getElementById('submit-loads-btn').addEventListener('click', async () => {
    const editorId = document.getElementById('editor').value;
    const date = document.getElementById('date').value;

    if (!editorId || !date) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —à–µ—Ñ–∞, —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∏ –¥–∞—Ç—É.');
        return;
    }

    let data = { editor: editorId, date: date };

    document.querySelectorAll('[data-project-id]').forEach(div => {
        const projectId = div.getAttribute('data-project-id');
        const hoursInput = document.getElementById(`hours_${projectId}`);
        const prioritySelect = div.querySelector(`select[name="priority_${projectId}"]`);

        if (hoursInput && hoursInput.value.trim() !== '') {
            data[`hours_${projectId}`] = hoursInput.value;
        }
        if (prioritySelect) {
            data[`priority_${projectId}`] = prioritySelect.value;
        }
    });

    try {
        const response = await fetch('/submit_loads', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö');
            return;
        }

        const result = await response.json();

        result.loads.forEach(load => {
            const el = document.getElementById(`display_hours_${load.project_id}`);
            if (el) {
                el.textContent = parseFloat(load.hours).toFixed(2);
            }
        });

        alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞');
    }
});

document.getElementById('clear-hours-btn').addEventListener('click', () => {
    clearLoadForm();
});

document.getElementById('save-project-btn').addEventListener('click', async () => {
    const nameInput = document.getElementById('project-name-input');
    const prioritySelect = document.getElementById('priority-select');
    const statusMsg = document.getElementById('project-status-msg');

    const name = nameInput.value.trim();
    const priority = prioritySelect.value;

    if (!name) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞');
        return;
    }

    try {
        const response = await fetch('/add_project', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name, priority })
        });

        const result = await response.json();

        if (response.ok) {
            statusMsg.style.display = 'block';
            statusMsg.textContent = `–ü—Ä–æ–µ–∫—Ç "${result.project.name}" –¥–æ–±–∞–≤–ª–µ–Ω —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º "${result.project.priority}"`;

            nameInput.value = '';
            prioritySelect.value = 'medium';

            setTimeout(() => window.location.reload(), 1500);
        } else {
            alert(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞');
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞');
    }
});

document.getElementById('delete-loads-btn').addEventListener('click', async () => {
    if (!confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —á–∞—Å—ã –Ω–∞–≥—Ä—É–∑–∫–∏?')) return;

    const editorId = document.getElementById('editor').value;
    const date = document.getElementById('date').value; // –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º

    if (!editorId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏');
        return;
    }

    try {
        const response = await fetch('/delete_loads', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ editor_id: editorId, date: date || null }),
        });

        if (!response.ok) {
            const err = await response.text();
            throw new Error(err || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏');
        }

        alert('–ß–∞—Å—ã –Ω–∞–≥—Ä—É–∑–∫–∏ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã');
        clearLoadForm();
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –Ω–∞–≥—Ä—É–∑–∫–∏: ' + e.message);
    }
});
</script>
</body>
</html>
