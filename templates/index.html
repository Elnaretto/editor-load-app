<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>–ù–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container py-4">

    <!-- üîò –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å—Ç—Ä–∞–Ω–∏—Ü -->
    <div class="mb-4 d-flex gap-2">
        <a href="{{ url_for('index') }}" class="btn btn-outline-primary">üè† –ì–ª–∞–≤–Ω–∞—è</a>
        <a href="{{ url_for('visualization') }}" class="btn btn-outline-success">üìä –ü–æ —à–µ—Ñ—É</a>
        <a href="{{ url_for('visualization_timeline') }}" class="btn btn-outline-info">üìà –î–∏–Ω–∞–º–∏–∫–∞</a>
    </div>

    <h1>–î–æ–±–∞–≤–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞</h1>

    <button onclick="window.location.href='{{ url_for('visualization') }}'" class="btn btn-secondary mb-3">–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</button>

    <form method="POST" action="{{ url_for('submit_loads') }}">
        <label for="chief">–í—ã–±–µ—Ä–∏—Ç–µ —à–µ—Ñ–∞:</label>
        <select id="chief" name="chief" required onchange="updateEditors()" class="form-select w-auto">
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
            {% for chief in chiefs %}
                <option value="{{ chief.id }}">{{ chief.name }}</option>
            {% endfor %}
        </select>

        <br><br>

        <label for="editor">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞:</label>
        <select id="editor" name="editor" required class="form-select w-auto">
            <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —à–µ—Ñ–∞ --</option>
        </select>

        <br><br>

        <label for="date">–î–∞—Ç–∞:</label>
        <input type="date" id="date" name="date" value="{{ today }}" required class="form-control w-auto">

        <br><br>

        <h3>–í–≤–µ–¥–∏—Ç–µ —á–∞—Å—ã –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º</h3>
        <div class="mb-3 border p-3 rounded">
            {% for project in projects %}
                <div class="mb-2 d-flex align-items-center gap-2">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background-color:
                        {% if project.priority == 'team-high' %}#ffcc00
                        {% elif project.priority == 'all-high' %}#ff0000
                        {% elif project.priority == 'above-average' %}#ff0000
                        {% elif project.priority == 'medium' %}#007bff
                        {% elif project.priority == 'low' %}#007bff
                        {% else %}#cccccc{% endif %};
                    " title="–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {{ project.priority }}"></div>
                    <label for="hours_{{ project.id }}" class="flex-grow-1 mb-0">{{ project.name }}</label>
                    <input type="number" step="0.1" min="0" name="hours_{{ project.id }}" id="hours_{{ project.id }}" value="0" class="form-control w-auto" style="max-width: 80px;">
                    <select name="priority_{{ project.id }}" class="form-select form-select-sm w-auto ms-2" style="min-width: 180px;">
                        <option value="team-high" {% if project.priority == 'team-high' %}selected{% endif %}>‚ö†Ô∏è –í—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –∫–æ–º–∞–Ω–¥—ã</option>
                        <option value="all-high" {% if project.priority == 'all-high' %}selected{% endif %}>‚ùó‚ùó‚ùó –í—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –≤—Å–µ—Ö</option>
                        <option value="above-average" {% if project.priority == 'above-average' %}selected{% endif %}>‚ùó –í—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                        <option value="medium" {% if project.priority == 'medium' %}selected{% endif %}>üîµ‚ùó –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                        <option value="low" {% if project.priority == 'low' %}selected{% endif %}>üîµ‚ùì –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                    </select>
                </div>
            {% endfor %}
        </div>

        <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>

    <!-- –§–æ—Ä–º–∞ –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ Excel -->
    <hr>
    <h5>–í—ã–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ Excel</h5>
    <form method="GET" action="{{ url_for('export_excel') }}" class="mb-4">
        <label for="startDate">–°:</label>
        <input type="date" id="startDate" name="start_date" required>
        <label for="endDate">–ü–æ:</label>
        <input type="date" id="endDate" name="end_date" required>
        <button type="submit" class="btn btn-primary ms-2">–í—ã–≥—Ä—É–∑–∏—Ç—å Excel</button>
    </form>

    <h5>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h5>
    <div style="max-width: 300px;">
        <input type="text" id="project-name-input" class="form-control mb-2" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞" />
        <select id="priority-select" class="form-select mb-2">
            <option value="team-high">‚ö†Ô∏è –í—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –∫–æ–º–∞–Ω–¥—ã</option>
            <option value="all-high">‚ùó‚ùó‚ùó –í—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –≤—Å–µ—Ö</option>
            <option value="above-average">‚ùó –í—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
            <option value="medium" selected>üîµ‚ùó –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
            <option value="low">üîµ‚ùì –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
        </select>
        <button id="save-project-btn" type="button" class="btn btn-primary mb-4">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
        <div id="project-status-msg" class="text-success" style="display:none;"></div>
    </div>

    <script>
        const editorsByChief = {
            {% for chief in chiefs %}
                "{{ chief.id }}": [
                    {% for editor in chief.editors %}
                        {"id": "{{ editor.id }}", "login": "{{ editor.login }}"},
                    {% endfor %}
                ],
            {% endfor %}
        };

        function updateEditors() {
            const chiefSelect = document.getElementById('chief');
            const editorSelect = document.getElementById('editor');
            const selectedChief = chiefSelect.value;

            editorSelect.innerHTML = '';

            if (!selectedChief || !editorsByChief[selectedChief]) {
                editorSelect.innerHTML = '<option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —à–µ—Ñ–∞ --</option>';
                return;
            }

            const editors = editorsByChief[selectedChief];
            editorSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ --</option>';

            editors.forEach(editor => {
                const option = document.createElement('option');
                option.value = editor.id;
                option.textContent = editor.login;
                editorSelect.appendChild(option);
            });
        }

        document.getElementById('save-project-btn').addEventListener('click', async () => {
            const nameInput = document.getElementById('project-name-input');
            const prioritySelect = document.getElementById('priority-select');
            const statusMsg = document.getElementById('project-status-msg');

            const name = nameInput.value.trim();
            const priority = prioritySelect.value;

            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞');
                return;
            }

            try {
                const response = await fetch('/add_project', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, priority})
                });

                const result = await response.json();

                if (response.ok) {
                    statusMsg.style.display = 'block';
                    statusMsg.textContent = `–ü—Ä–æ–µ–∫—Ç "${result.project.name}" –¥–æ–±–∞–≤–ª–µ–Ω —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º "${result.project.priority}"`;

                    nameInput.value = '';
                    prioritySelect.value = 'medium';

                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    alert(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞');
                }
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞');
            }
        });
    </script>

</body>
</html>
