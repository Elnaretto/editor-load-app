<!DOCTYPE html>
<html lang="ru">
<head>
<link href="https://fonts.googleapis.com/css?family=DM+Sans:400,500,700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<link href="https://fonts.googleapis.com/css?family=DM+Sans:400,500,700&display=swap" rel="stylesheet">
  <meta charset="UTF-8" />
  <title>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container py-4">

  <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å—Ç—Ä–∞–Ω–∏—Ü -->
  <div class="mb-4 d-flex gap-2">
    <a href="{{ url_for('index') }}" class="btn btn-outline-primary">üè† –ì–ª–∞–≤–Ω–∞—è</a>
    <a href="{{ url_for('visualization') }}" class="btn btn-outline-success">üìä –ü–æ —à–µ—Ñ—É</a>
    <a href="{{ url_for('visualization_timeline') }}" class="btn btn-outline-info">üìà –î–∏–Ω–∞–º–∏–∫–∞</a>
    <a href="{{ url_for('visualization_editors') }}" class="btn btn-outline-info" >üëå–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤</a>
  </div>

  <h1>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º</h1>

  <!-- –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ —Å –ø–æ–ª–µ–º –¥–∞—Ç—ã -->
  <form method="get" action="{{ url_for('visualization') }}" class="mb-3">
    <div class="row g-3">
      <div class="col-md-4">
        <label for="chief-select" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —à–µ—Ñ–∞:</label>
        <select id="chief-select" name="chief_id" class="form-select" onchange="this.form.submit()">
          <option value="0" {% if selected_chief_id == 0 %}selected{% endif %}>–í—Å—è —Ä–µ–¥–∞–∫—Ü–∏—è</option>
          {% for chief in chiefs %}
            <option value="{{ chief.id }}" {% if chief.id == selected_chief_id %}selected{% endif %}>
              {{ chief.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      
      <div class="col-md-4">
        <label for="date-select" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –≤—Å–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏):</label>
        <input type="date" 
               id="date-select" 
               name="date" 
               class="form-control" 
               value="{{ selected_date or '' }}"
               onchange="this.form.submit()">
      </div>
      
      <div class="col-md-4 d-flex align-items-end">
        <button type="submit" class="btn btn-primary me-2">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <a href="{{ url_for('visualization') }}" class="btn btn-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
      </div>
    </div>
  </form>

  {% if message %}
    <div class="alert alert-info">{{ message }}</div>
  {% endif %}

{% if graph_html %}
  <div id="graph-container">
    {{ graph_html | safe }}
  </div>

  {% if details %}
    <h2>–î–µ—Ç–∞–ª–∏ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º –∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞–º:</h2>
    <ul>
      {% for project, editors in details.items() %}
        <li><strong>{{ project }}</strong>
          <ul>
            {% for item in editors %}
              <li>{{ item.editor }}: {{ "%.2f"|format(item.hours) }} —á–∞—Å–æ–≤</li>
            {% endfor %}
          </ul>
        </li>
      {% endfor %}
    </ul>
  {% endif %}
{% endif %}

  <form method="GET" action="{{ url_for('export_excel') }}" style="margin-top: 20px;">
    <div class="row g-3">
      <div class="col-md-3">
        <label for="startDate" class="form-label">–°:</label>
        <input type="date" id="startDate" name="start_date" class="form-control" required>
      </div>
      <div class="col-md-3">
        <label for="endDate" class="form-label">–ü–æ:</label>
        <input type="date" id="endDate" name="end_date" class="form-control" required>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-success">–í—ã–≥—Ä—É–∑–∏—Ç—å Excel</button>
      </div>
    </div>
  </form>

  <br>
  <button onclick="window.history.back()" class="btn btn-secondary">–ù–∞–∑–∞–¥</button>

</body>
<script>
  const selectedChiefId = {{ selected_chief_id or 0 }};
  const selectedDate = "{{ selected_date or '' }}";
  
  async function refreshData() {
    try {
      let url = `/api/visualization_data?chief_id=${selectedChiefId}`;
      if (selectedDate) {
        url += `&date=${selectedDate}`;
      }
      
      const response = await fetch(url);
      if (!response.ok) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏");
        return;
      }
      const data = await response.json();
      
      // –ó–¥–µ—Å—å –æ–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
      const graphDiv = document.getElementById('graph-container');
      if (!graphDiv) return;

      graphDiv.innerHTML = data.graph_html;

      // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –æ–±–Ω–æ–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
      // ...
      
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏", error);
    }
  }

  // –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
  setInterval(refreshData, 10000);
</script>
</html>